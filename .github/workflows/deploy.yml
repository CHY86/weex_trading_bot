name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy code via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          script: |
            # 1. 進入專案資料夾 & 更新代碼
            cd /home/ubuntu/weex_trading_bot
            git pull origin main
            
            # 2. [新增步驟] 安裝 Python 套件管理工具 pip
            sudo apt-get update
            sudo apt-get install -y python3-pip

            # 3. [關鍵修復] 安裝缺少的 Python 套件
            # 注意：必須安裝 'websocket-client' (而不是 websocket)
            # --break-system-packages 是為了繞過 Ubuntu 的保護機制
            sudo pip3 install requests websocket-client --break-system-packages

            # 4. 建立 Systemd 服務設定檔
            sudo bash -c 'cat > /etc/systemd/system/trading_bot.service <<EOF
            [Unit]
            Description=Weex AI Trading Bot
            After=network.target

            [Service]
            Type=simple
            User=ubuntu
            WorkingDirectory=/home/ubuntu/weex_trading_bot
            ExecStart=/usr/bin/python3 /home/ubuntu/weex_trading_bot/main.py
            Restart=always
            RestartSec=3

            [Install]
            WantedBy=multi-user.target
            EOF'

            echo "✅ Systemd service file created."

            # 5. 重新載入設定 & 啟動服務
            sudo systemctl daemon-reload
            sudo systemctl enable trading_bot
            sudo systemctl restart trading_bot

            echo "✅ Bot restarted via Systemd with dependencies installed."