name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy code via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          script: |
            # 1. 進入專案資料夾 & 更新代碼
            cd /home/ubuntu/weex_trading_bot
            git pull origin main
            
            # 2. 建立 Systemd 服務設定檔 (如果已存在會覆蓋)
            # 這裡定義了機器人如何啟動、崩潰後如何重啟
            sudo bash -c 'cat > /etc/systemd/system/trading_bot.service <<EOF
            [Unit]
            Description=Weex AI Trading Bot
            After=network.target

            [Service]
            Type=simple
            User=ubuntu
            WorkingDirectory=/home/ubuntu/weex_trading_bot
            # 指定 Python 路徑與程式路徑
            ExecStart=/usr/bin/python3 /home/ubuntu/weex_trading_bot/main.py
            # 關鍵設定：程式掛掉會自動重啟
            Restart=always
            RestartSec=3

            [Install]
            WantedBy=multi-user.target
            EOF'

            echo "✅ Systemd service file created."

            # 3. 重新載入設定 & 啟動服務
            # 這些指令都是「瞬間完成」的，不會卡住 SSH
            sudo systemctl daemon-reload
            sudo systemctl enable trading_bot
            sudo systemctl restart trading_bot

            echo "✅ Bot restarted via Systemd. Disconnecting..."